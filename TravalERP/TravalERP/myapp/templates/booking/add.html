
{% extends "base/base.html" %} {% block content %}

<div class="container">
  <h1 class="mt-5 title">수배등록</h1>
</div>

<div class="container mt-5">
  <form id="bookingFrm">
    {% csrf_token %}
    <div class="row">
      <label for="ref" class="col-sm-1 col-form-label">ref</label>
      <div class="col-sm-4">
        <input id="ref" type="text" class="form-control" />
      </div>
      <div class="col-sm-1"></div>
      <label for="product_name" class="col-sm-1 col-form-label">상품명</label>
      <div class="col-sm-5">
        <input id="product_name" name="product_name" type="text" class="form-control" />
      </div>
    </div>
    <div class="row mt-2">
      <label for="url" class="col-sm-1 col-form-label">URL</label>
      <div class="col-sm-11">
        <input id="url" type="url" class="form-control" />
      </div>
    </div>
    <div class="devider"></div>
    <div class="row mt-2">
		<label for="agent" class="col-sm-1 col-form-label">여행사</label>
		<div class="col-sm-4">
			<select id="agent" name="agent" class="form-control selectpicker" aria-label="agent_name" onchange="changeAgent(this)" data-live-search="true" style="display: none;" id="agent" data-none-selected-text="조건을 찾을 수 없습니다">
			<option value="">여행사명</option>
			{% for agent in optionData.agent %}
			<!-- optionData 로 온 Object에서 agent만 선택하여 for문 돌린다-->
			<option value="{{agent.id}}">{{agent.agent_name}}</option>
			{% endfor %}
			</select>
		</div>
		<div class="col-sm-1"></div>
		<label for="manager" class="col-sm-1 col-form-label">담당자</label>
		<div class="col-sm-4">
			<select id="manager" name="manager" class="form-control  selectpicker" aria-label="manager" data-live-search="true" style="display: none;" id="manager" data-none-selected-text="조건을 찾을 수 없습니다">
			<option value="">담당자명</option>
			</select>
		</div>
    </div>
    <div class="devider"></div>
    <div class="row mt-2">
      <label for="localagent" class="col-sm-1 col-form-label">현지사무실</label>
      <div class="col-sm-4">
        <select class="form-control selectpicker" aria-label="localagent_name" onchange="changeAgent(this)" data-live-search="true" style="display: none;" id="localAgent" data-none-selected-text="조건을 찾을 수 없습니다">
          <option value="">현지사무실명</option>
          {% for agent in optionData.localAgent %}
          <option value="{{agent.id}}">{{agent.agent_name}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-sm-1"></div>
      <label for="localmanager" class="col-sm-1 col-form-label">담당자</label>
      <div class="col-sm-4">
        <select class="form-control  selectpicker" aria-label="localmanager" data-live-search="true" style="display: none;" id="localmanager" data-none-selected-text="조건을 찾을 수 없습니다">
          <option value="">담당자명</option>
        </select>
      </div>
    </div>
    <div class="devider"></div>
    <div class="row">
      <p>AIR</p>
      <label for="kor_air_def" class="col-sm-1 col-form-label">한국출발</label>
      <div class="col-sm-2">
        <input id="kor_air_def" type="text" class="datepicker form-control" placeholder="출발일" />
      </div>
      <label for="kor_air" class="col-sm-1 col-form-label">항공편</label>
      <div class="col-sm-2">
        <select class="form-control selectpicker" id="kor_air" name="kor_air" data-live-search="true" style="display: none;" onchange="select_air(this)">
          <option value="" selected>항공편명</option>
          {% for airport in optionData.airport %}
          <option value="{{airport.id}}" data-out="{{airport.arrival_airport}}" data-in="{{airport.departure_airport}}" data-timedep="{{airport.departure_time}}" data-timearri="{{airport.arrival_time}}">{{airport.airport_name}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-sm-1">
        <input type="text" class="form-control" id="kor_air_in" name="kor_air_in" readonly />
      </div>
      <div class="col-sm-1">
        <input type="text" class="form-control"id="kor_air_out" name="kor_air_out"  readonly />
      </div>
      <div class="col-sm-2">
        <input type="text" class="form-control"id="kor_air_time_dep" name="kor_air_time_dep"  readonly />
      </div>
      <div class="col-sm-2">
        <input type="text" class="form-control"id="kor_air_time_arri" name="kor_air_time_arri"  readonly />
      </div>
    </div>
    <div class="row mt-2">
      <label for="loc_air_def" class="col-sm-1 col-form-label">현지출발</label>
      <div class="col-sm-2">
        <input id="loc_air_def" type="text" class="datepicker form-control" placeholder="현지출발일">
      </div>
      <label for="loc_air" class="col-sm-1 col-form-label">항공편</label>
      <div class="col-sm-2">
        <select class="form-control selectpicker" id="local_air" name="local_air" data-live-search="true" style="display: none;"  onchange="select_air(this)">
          <option value="" selected>항공편명</option>
          {% for airport in optionData.airport %}
          <option value="{{airport.id}}" data-out="{{airport.arrival_airport}}" data-in="{{airport.departure_airport}}" data-timedep="{{airport.departure_time}}" data-timearri="{{airport.arrival_time}}">{{airport.airport_name}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-sm-1">
        <input type="text" class="form-control" id="local_air_in" name="local_air_in" readonly />
      </div>
      <div class="col-sm-1">
        <input type="text" class="form-control" id="local_air_out" name="local_air_out" readonly />
      </div>
      <div class="col-sm-2">
        <input type="text" class="form-control"id="loc_air_time_dep" name="loc_air_time_dep"  readonly />
      </div>
      <div class="col-sm-2">
        <input type="text" class="form-control"id="loc_air_time_arri" name="loc_air_time_arri"  readonly />
      </div>
    </div>
    <div class="devider"></div>
    <div class="row">
      <p>MEAL</p>
      <label for="breakfast" class="col-sm-1 col-form-label">조식</label>
      <div class="col-sm-2">
        <input id="breakfast" name="breakfast" type="text" class="form-control" readonly />
      </div>
      <label for="lunch" class="col-sm-1 col-form-label">중식</label>
      <div class="col-sm-2">
        <input id="lunch" name="lunch" type="text" class="form-control" readonly />
      </div>
      <label for="dinner" class="col-sm-1 col-form-label">석식</label>
      <div class="col-sm-2">
        <input id="dinner" name="dinner" type="text" class="form-control" readonly />
      </div>
      <div class="col-sm-3 text-end">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
          등록일정 검색
        </button>
      </div>
    </div>
    <div class="row mt-3">
      <label for="special" class="col-sm-1 col-form-label">특식</label>
      <div class="col-sm-11">
        <input id="special" name="special" type="text" class="form-control" style="height: 80px" readonly/>
      </div>
    </div>
    <div class="devider"></div>
    <div class="row">
      <label for="option" class="col-sm-1 col-form-label">옵션</label>
      <div class="col-sm-11">
        <input id="option" name="option" type="text" class="form-control" style="height: 80px" />
      </div>
    </div>
    <div class="row mt-3">
      <label for="shopping" class="col-sm-1 col-form-label">쇼핑</label>
      <div class="col-sm-11">
        <input id="shopping" name="shopping" type="text" class="form-control" style="height: 80px" />
      </div>
    </div>
    <div class="devider"></div>
    <div class="row">
      <label for="bus" class="col-sm-1 col-form-label">BUS</label>
      <div class="col-sm-4">
        <input id="bus" name="bus" type="text" class="form-control" style="height: 80px" />
      </div>
      <div class="col-sm-1"></div>
      <label for="entrance" class="col-sm-1 col-form-label">ENTRANCE</label>
      <div class="col-sm-5">
        <input id="entrance" name="entrance" type="text" class="form-control" style="height: 80px" />
      </div>
    </div>
    <div class="devider"></div>
    <div class="row">
      <p>GUIDE</p>
      <label for="kor_guide" class="col-sm-1 col-form-label">KOR</label>
      <div class="col-sm-5">
        <input id="kor_guide" type="text" class="form-control" style="height: 80px"/>
      </div>
      <label for="loc_guide" class="col-sm-1 col-form-label">LOC</label>
      <div class="col-sm-5">
        <input id="loc_guide" type="text" class="form-control" style="height: 80px"/>
      </div>
    </div>
    <div class="devider"></div>
    <div class="row">
      <p>SCHDULE</p>
      <table class="table mx-3" >
        <thead class="table-light">
          <tr>
            <th scope="col">일차</th>
            <th scope="col">날짜</th>
            <th scope="col">일정</th>
          </tr>
        </thead>
        <tbody  id="schdule_table">
         
        </tbody>
      </table>
    </div>
    <div class="devider"></div>
    <div class="row">
      <label for="hotel" class="col-form-label">HOTEL</label>
      <div class="p-3">
        <table class="table table-centered table-nowrap mb-2 text-center" id="hotel_table">
          <thead class="table-light">
            <tr>
              <th style="width: 20px">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="customCheck1"/>
                  <label class="form-check-label" for="customCheck1">&nbsp;</label>
                </div>
              </th>
              <th class="col-sm-2">날짜</th>
              <th class="col-sm-2">지역</th>
              <th class="col-sm-1">숙박일수</th>
              <th class="col-sm-5">호텔</th>
              <th class="col-sm-2">비고</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="customCheck2"/>
                  <label class="form-check-label" for="customCheck2">&nbsp;</label>
                </div>
              </td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="customCheck2"/>
                  <label class="form-check-label" for="customCheck2">&nbsp;</label>
                </div>
              </td>
              <td></td>
              <td>BCN</td>
              <td>1NT</td>
              <td>1ST 사용 기준 - 5성 1박, 파라도르 1박 사용 기준</td>
              <td></td>
            </tr>
            <tr>
              <td>
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="customCheck2"/>
                  <label class="form-check-label" for="customCheck2">&nbsp;</label>
                </div>
              </td>
              <td></td>
              <td>VLC</td>
              <td>1NT</td>
              <td>1ST 사용 기준 - 5성 1박, 파라도르 1박 사용 기준</td>
              <td></td>
            </tr>
            <tr>
              <td>
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="customCheck2"/>
                  <label class="form-check-label" for="customCheck2">&nbsp;</label>
                </div>
              </td>
              <td></td>
              <td>GRX</td>
              <td>1NT</td>
              <td>1ST 사용 기준 - 5성 1박, 파라도르 1박 사용 기준</td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="devider"></div>
    <div class="row">
      <label for="remark" class="col-sm-1 col-form-label">REMARK</label>
      <div class="col-sm-11">
        <textarea id="remark" class="form-control" style="height: 100px"></textarea>
      </div>
    </div>
    <div class="text-end mt-5">
      <button type="submit" class="btn btn-primary">저장</button>
      <button type="reset" class="btn btn-secondary">초기화</button>
      <button type="button" class="btn btn-secondary">취소</button>
    </div>
  </form>
</div>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">일정검색</h5>
		<button type="button" class="btn btn-success" onclick="searchSchedule();">검색</button>
	</div>
	<div class="modal-body">
		<div class="input-group" >
			<div class="row mt-2 col-12">
				<label for="prodName" class="col-2 col-form-label">상품명</label>
				<div class="col-10">
				  <input id="prodName" name="prodName" type="text" class="form-control" />
				</div>
			</div>
			<div class="row mt-2 col-12">
				<label for="agent" class="col-2 col-form-label">여행사</label>
				<div class="col-4">
					<select class="form-control selectpicker" aria-label="agent_name" onchange="changeAgent(this)" data-live-search="true" style="display: none;" id="agent" data-none-selected-text="조건을 찾을 수 없습니다">
						<option value="">여행사명</option>
						{% for agent in optionData.agent %}
						<!-- optionData 로 온 Object에서 agent만 선택하여 for문 돌린다-->
						<option value="{{agent.id}}">{{agent.agent_name}}</option>
						{% endfor %}
					</select>
				</div>
				<label for="manager" class="col-2 col-form-label">담당자</label>
				<div class="col-4">
					<select class="form-control  selectpicker" aria-label="manager" data-live-search="true" style="display: none;" id="manager" data-none-selected-text="조건을 찾을 수 없습니다">
						<option value="">담당자명</option>
					</select>
				</div>
			</div>
			<div class="devider"></div>
        <div class="row mt-2 col-12" id="">
          <div class="col-8" style="text-align: center;">상품명</div>
          <div class="col-1" style="text-align: center;">박</div>
          <div class="col-1" style="text-align: center;">일</div>
          <div class="col-2" style="text-align: center;">담당자</div>
        </div>
        <div class="row mt-2 col-12" id="result_div">

        </div>
      </div>
      </div>
    </div>
  </div>
</div>

<script>
	function searchSchedule(){
		var prodName = $(".modal-body #product_name").val();
		var agent = $(".modal-body #agent").val();
		var manager = $(".modal-body #manager").val();

		$("#tmpSearchScheduleFrm").remove();
		var frm = makeForm('', 'tmpSearchScheduleFrm');

		if (prodName == undefined || prodName == 'undefined' || prodName == ''){
		}
		else{
			frm.appendChild(addData('product_name', prodName));
		}

		if (agent == undefined || agent == 'undefined' || agent == ''){
		}
		else{
			frm.appendChild(addData('agent', agent));
		}

		if (manager == undefined || manager == 'undefined' || manager == ''){
		}
		else{
			frm.appendChild(addData('manager', manager));
		}
		frm.appendChild(addData('use_yn', 'Y'));
		document.body.appendChild(frm);
	
		getAjax('tmpSearchScheduleFrm', 'scheduleMaster', 'searchScheduleSucc');

	}

  var searchMaster;

	function searchScheduleSucc(data){
    searchMaster = '';
		searchMaster = data;
    // 상품명 / 몇박 몇일 / 담당자
    var result = $("#result_div");
    result.empty();
    for (var i = 0; i < data.length; i ++){
      result.append("<div class='col-8' style='text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;' data-row="+i+">"+data[i].product_name+"</div>")
      result.append("<div class='col-1' style='text-align: center;' data-row="+i+">"+data[i].night+"</div>")
      result.append("<div class='col-1' style='text-align: center;' data-row="+i+">"+data[i].day+"</div>")
      result.append("<div class='col-2' style='text-align: center;' data-row="+i+">"+data[i].manager_id+"</div>")
    }

    // 이후 master id로 스케쥴 디테일 가져오기
    searchScheduleDetail(data[0].id);
	}
  function searchScheduleDetail(master_id){
    $("#tmpSearchScheduleDeatilFrm").remove();
		var frm = makeForm('', 'tmpSearchScheduleDeatilFrm');
    frm.appendChild(addData('use_yn', 'Y'));
    frm.appendChild(addData('master_id', master_id));
		document.body.appendChild(frm);
	
		getAjax('tmpSearchScheduleDeatilFrm', 'scheduleDetail', 'searchScheduleDetailSucc');

  }

  function searchScheduleDetailSucc(data){
    console.log(data)
    var detail = $("#schdule_table");
    detail.empty();
    for (var i = 0; i < data.length; i ++){
      detail.append("<tr>")
      detail.append("<td scope='col'>"+data[i].day+"일차</td>")
      detail.append("<td scope='col'></td>")
      detail.append("<td scope='col'>"+data[i].schedule+"</td>")
      detail.append("</tr>")
    }
  }

  $(document).on('dblclick', '#result_div > div', function() {
      var row = $(this).data('row');
      var id = searchMaster[row].id;
      // 여행사, 담당자 넣기
      var agent = $("#tmpSearchScheduleFrm #agent").val();
      var manager = $("#tmpSearchScheduleFrm #manager").val();
      $('#bookingFrm select[name="agent"]').selectpicker('val', agent);
      $('#bookingFrm select[name="manager"]').selectpicker('val', manager);
      // 각각의 input에 데이터 넣기
      for (var key in searchMaster[0]) {
        var value = searchMaster[0][key];
        var input = $('#bookingFrm input[name="' + key + '"]');
        input.val(value);
      }
      // 디테일 검색 이후 모달 닫기
      console.log(searchMaster)
      $('#myModal').modal('hide');
      

  });

  function select_air(element){
    // 선택한 option에서 data-in과 data-out 값 가져오기
    var data_in = $(element).find(':selected').data('in');
    var data_out = $(element).find(':selected').data('out');
    var data_timedep = $(element).find(':selected').data('timedep');
    var data_timearri = $(element).find(':selected').data('timearri');

    // 선택한 select box에 따라서 데이터를 적용할 input 태그 선택
    var air_in, air_out
    if (element.id === "kor_air") {
      air_in = $("#kor_air_in");
      air_out = $("#kor_air_out");
      air_timedep = $("#kor_air_time_dep");
      air_timearri = $("#kor_air_time_arri");
    } else if (element.id === "local_air") {
      air_in = $("#local_air_in");
      air_out = $("#local_air_out");
      air_timedep = $("#loc_air_time_dep");
      air_timearri = $("#loc_air_time_arri");
    }


    // input 태그에 데이터 적용
    air_in.val(data_in);
    air_out.val(data_out);
    air_timedep.val(data_timedep);
    air_timearri.val(data_timearri);
  }
  $( document ).ready(function() {
    //changeAgent();
  });

  function changeAgent(element){
    $("#tmpChangeAgentFrm").remove();
    var frm = makeForm('', 'tmpChangeAgentFrm');

    frm.appendChild(addData('agent', ($(element).val())));
    document.body.appendChild(frm);

    getAjax('tmpChangeAgentFrm', 'manager', 'changeAgentSucc', element);

  }

  function changeAgentSucc(data, element){
	var select = $($(element).closest('.row').find('select')[1]);

    select.selectpicker('destroy');
    select.empty();
    for (var i = 0; i < data.length; i++) {
        var option = $('<option>', {
            value: data[i].id,
            text: data[i].manager_name
        });
        select.append(option);
    }

    select.selectpicker(); 

}

  $.datepicker.setDefaults({
    dateFormat: 'yy-mm-dd',
    showOtherMonths: true,
    changeYear: true,
    changeMonth: true,
  });


  $(function() {
    // id kor_air_def의 datepicker 선택시
    $('#kor_air_def').datepicker({
      onSelect: function(date) {
        // 선택된 날짜로 Date 변수를 만든다
        var selDate = new Date(date);
        // 해당 날짜에서 년,월,일을 각각 뽑는다. ( month는 +1을 해줘야 해당 month 가 제대로 나옴)
        var selYear = selDate.getFullYear();
        var selMonth = selDate.getMonth()+1;
        var selDay = selDate.getDate();

        // schedule_table, hotel_table
        var schdule_table = $('#schdule_table');
        var hotel_table = $('#hotel_table');

        // 테이블에서 tr을 찾아 tr수만큼 for문을 돌린다.
        schdule_table.find('tr').each(function(index, row) {
          // 첫 번째 행(th)은 스킵합니다.
          if (index === 0) {
            return true;
          }
          // 각 행(row)의 두 번째 셀(td)에 오늘 날짜를 입력합니다. 선택한 날짜에서 (index-1)을 더해서 날짜를 만든뒤, 넣어준다.
          var toDate = new Date(selYear, selMonth, selDay + index - 1);
          var toYear = toDate.getFullYear();
          var toMonth = ('0' +toDate.getMonth()).slice(-2);// 앞에 0을 붙이고 뒤에서 2개만 선택한다. 1자리수 인경우 앞에 0붙이는것
          var toDay = ('0' +toDate.getDate()).slice(-2);
          $(row).find('td:nth-child(2)').text(toYear+'-'+toMonth+"-"+toDay);

        });
        hotel_table.find('tr').each(function(index, row) {
          // 첫 번째 행(th)은 스킵합니다.
          if (index === 0) {
            return true;
          }
          // 각 행(row)의 두 번째 셀(td)에 오늘 날짜를 입력합니다.
          var toDate = new Date(selYear, selMonth, selDay + index - 1);
          var toYear = toDate.getFullYear();
          var toMonth = ('0' +toDate.getMonth()).slice(-2);
          var toDay = ('0' +toDate.getDate()).slice(-2);
          $(row).find('td:nth-child(2)').text(toYear+'-'+toMonth+"-"+toDay);

        });

      }
    });
  });

  function openSearch() {
			var searchUrl = "/booking/search/";
			var childWindow = window.open(searchUrl, "Search", "width=600,height=400");
			childWindow.focus();
  }
</script>

<style>
  .devider {
    width: 100%;
    height: 5px;
    border-top: rgba(155, 151, 151, 0.979) 2px solid;
    margin: 20px 10px 20px 0px;
  }
  .title {
    font-size: 30px;
    font-weight: bolder;
    margin-bottom: 20px;
  }

  .tr_row {
    margin-bottom: 10px;
  }

  .tr_row label {
    width: 5rem;
    text-align: justify;
  }
  .tr_row input {
    width: 10rem;
    margin-right: 10px;
  }
</style>


{% endblock %} {% block js %} {{block.super}} {% endblock js %}




